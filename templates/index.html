{% extends "base.html" %}

{% block title %}Dashboard - Expense Tracker{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Budget Alerts -->
    {% if budget_alerts %}
    <div class="alerts-section">
        <h3>‚ö†Ô∏è Budget Alerts</h3>
        <div class="alerts-grid">
            {% for alert in budget_alerts %}
            <div class="alert-card {{ alert.type }}">
                <div class="alert-icon">
                    {% if alert.type == 'danger' %}üö®{% else %}‚ö†Ô∏è{% endif %}
                </div>
                <div class="alert-content">
                    <strong>{{ alert.category }}</strong>
                    <div>{{ alert.message }}</div>
                </div>
                <div class="alert-percentage">{{ "%.0f"|format(alert.percentage) }}%</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Pending Recurring Transactions -->
    {% if pending_recurring %}
    <div class="alerts-section">
        <h3>üîÑ Pending Recurring Transactions</h3>
        <div class="recurring-pending">
            {% for recurring in pending_recurring %}
            <div class="pending-item">
                <div class="pending-info">
                    <strong>{{ recurring.title }}</strong>
                    <span class="pending-date">Due: {{ recurring.next_date }}</span>
                </div>
                <div class="pending-amount">‚Ç¨{{ "%.2f"|format(recurring.amount) }}</div>
                <a href="{{ url_for('execute_recurring_transaction', recurring_id=recurring.id) }}" 
                   class="btn btn-small btn-success">Execute</a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Summary Stats -->
    <div class="stats-grid">
        <div class="stat-card income">
            <div class="stat-value">‚Ç¨{{ "%.2f"|format(total_income) }}</div>
            <div class="stat-label">Total Income</div>
        </div>
        <div class="stat-card expense">
            <div class="stat-value">‚Ç¨{{ "%.2f"|format(total_expense) }}</div>
            <div class="stat-label">Total Expenses</div>
        </div>
        <div class="stat-card balance">
            <div class="stat-value">‚Ç¨{{ "%.2f"|format(balance) }}</div>
            <div class="stat-label">Net Balance</div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <h2>Quick Actions</h2>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('add_transaction') }}" class="btn btn-success">‚ûï Add Transaction</a>
            <a href="{{ url_for('budgets') }}" class="btn">üí∞ Manage Budgets</a>
            <a href="{{ url_for('analytics') }}" class="btn">üìä View Analytics</a>
            <a href="{{ url_for('categories') }}" class="btn btn-secondary">üè∑Ô∏è Categories</a>
            <a href="{{ url_for('reports') }}" class="btn btn-secondary">ÔøΩ Reports</a>
            <a href="{{ url_for('export_csv') }}" class="btn btn-secondary">üì• Export Data</a>
        </div>
    </div>

    <!-- Monthly Chart -->
    {% if monthly_data %}
    <div class="card">
        <h2>Monthly Overview</h2>
        <div class="chart-container">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>
    {% endif %}

    <!-- Recent Transactions -->
    <div class="card">
        <h2>Recent Transactions</h2>
        {% if recent_transactions %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in recent_transactions %}
                    <tr>
                        <td>{{ transaction.date }}</td>
                        <td>{{ transaction.description or 'No description' }}</td>
                        <td>{{ transaction.category_name or 'No category' }}</td>
                        <td>
                            {% if transaction.type == 'income' %}
                                <span style="color: #2ecc71;">Income</span>
                            {% else %}
                                <span style="color: #e74c3c;">Expense</span>
                            {% endif %}
                        </td>
                        <td class="amount-{{ transaction.type }}">‚Ç¨{{ "%.2f"|format(transaction.amount) }}</td>
                        <td>
                            <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-small btn-secondary">Edit</a>
                            <a href="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" 
                               class="btn btn-small btn-danger" 
                               onclick="return confirm('Are you sure you want to delete this transaction?')">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>No transactions yet. <a href="{{ url_for('add_transaction') }}">Add your first transaction</a>!</p>
        {% endif %}
    </div>
</div>

<script>
// Monthly data for chart
const monthlyData = [
    {% for data in monthly_data %}
    {
        month: "{{ data.month }}",
        income: {{ data.income or 0 }},
        expense: {{ data.expense or 0 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];
</script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize chart with monthly data
    const chartCanvas = document.getElementById('expenseChart');
    if (chartCanvas && monthlyData.length > 0) {
        const chart = new ExpenseChart('expenseChart');
        chart.drawMonthlyChart(monthlyData);
    }
});
</script>
{% endblock %}